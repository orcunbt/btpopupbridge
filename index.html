
<!DOCTYPE html>
<html>

<head>
  <title>PayPal Smart Buttons PopupBridge Example</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="icon" type="image/x-icon" href="favicon.ico">
  <link rel="stylesheet" href="style.css">

    <script>
    (function() {
      // Keep a reference to the original addEventListener
      const origAdd = window.addEventListener;

      // Override window.addEventListener
      window.addEventListener = function(type, handler, options) {
        if (type === 'message') {
          // Wrap the SDK’s handler so we can filter events
          const filtered = function(event) {
            let data;
            try {
              data = typeof event.data === 'string'
                ? JSON.parse(event.data)
                : event.data;
            } catch (_) {
              return; // not JSON ⇒ ignore
            }
            if (data.opType === undefined) {
              // Drop anything without a valid opType…
              event.stopImmediatePropagation();  // Prevents all later 'message' listeners :contentReference[oaicite:0]{index=0}
              return;
            }
            // Only genuine messages make it through
            return handler.call(this, event);
          };
          // Use capture so it runs before the SDK’s non-capturing listener :contentReference[oaicite:1]{index=1}
          return origAdd.call(this, type, filtered, true);
        }
        // All other events proceed as normal
        return origAdd.call(this, type, handler, options);
      };
    })();
  </script>
  <script src="https://js.braintreegateway.com/web/3.125.0/js/paypal-checkout.js"></script>
</head>

<body>
  <div>
    <a href="index.html"><- Back</a>
  </div>

  <h1>PayPal Smart Buttons PopupBridge Example</h1>

  <div id="paypal-button-container"></div>
  <pre id="log"></pre>


  <script>
    var log = document.querySelector('#log');

    braintree.paypalCheckout.create({
      authorization: 'sandbox_f252zhq7_hh4cpc39zq4rgjcg'
    }).then(function (paypalCheckoutInstance) {
      return paypalCheckoutInstance.loadPayPalSDK({
        vault: true
      });
    }).then(function (paypalCheckoutInstance) {
      return paypal.Buttons({
        fundingSource: paypal.FUNDING.PAYPAL,
        createBillingAgreement: function () {
          return paypalCheckoutInstance.createPayment({
            flow: 'vault'
          });
        },

        onApprove: function (data, actions) {
          return paypalCheckoutInstance.tokenizePayment(data).then(function (payload) {
            log.innerText = JSON.stringify(payload, null, 2);
          });
        },

        onCancel: function (err) {
          console.log('User cancelled');
          log.innerText = 'User cancelled';
        },

        onError: function (err) {
          console.log('onError fired');
          log.innerText = err.message;
        }
      }).render('#paypal-button-container');
    }).catch(function (err) {
      console.error('Error!', err);
    });
  </script>
</body>

</html>
