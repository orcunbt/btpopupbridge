
<!DOCTYPE html>
<html>

<head>
  <title>PayPal Smart Buttons PopupBridge Example</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="icon" type="image/x-icon" href="favicon.ico">
  <link rel="stylesheet" href="style.css">
  <script>
// Run first, before loading any Braintree/PayPal script
window.addEventListener('message', event => {
  // Allow PayPal origin messages (adjust if you use other endpoints)
  const allowed = [
    'https://www.paypal.com',
    'https://www.sandbox.paypal.com'
  ];

  if (!allowed.includes(event.origin)) {
    // Prevent unrelated postMessages (your own code or other widgets)
    event.stopImmediatePropagation();
  }
}, true /* capture */);
</script>

  <script src="https://js.braintreegateway.com/web/3.125.0/js/paypal-checkout.js"></script>
</head>

<body>
  <div>
    <a href="index.html"><- Back</a>
  </div>

  <h1>PayPal Smart Buttons PopupBridge Example</h1>

  <div id="paypal-button-container"></div>
  <pre id="log"></pre>


  <script>
    var log = document.querySelector('#log');

    braintree.paypalCheckout.create({
      authorization: 'sandbox_f252zhq7_hh4cpc39zq4rgjcg'
    }).then(function (paypalCheckoutInstance) {
      return paypalCheckoutInstance.loadPayPalSDK({
        vault: true
      });
    }).then(function (paypalCheckoutInstance) {
      return paypal.Buttons({
        fundingSource: paypal.FUNDING.PAYPAL,
        createBillingAgreement: function () {
          return paypalCheckoutInstance.createPayment({
            flow: 'vault'
          });
        },

        onApprove: function (data, actions) {
          return paypalCheckoutInstance.tokenizePayment(data).then(function (payload) {
            log.innerText = JSON.stringify(payload, null, 2);
          });
        },

        onCancel: function (err) {
          console.log('User cancelled');
          log.innerText = 'User cancelled';
        },

        onError: function (err) {
  if (err.message.startsWith('Unhandleable opType')) {
    console.log('Flow cancelled via window close');
    log.innerText = 'Flow cancelled via window close';
    return;
  }
    // Otherwise handle real errorsâ€¦

              console.log('Real error:', err);
    log.innerText = err.message;
     
        }
      }).render('#paypal-button-container');
    }).catch(function (err) {
      console.error('Error!', err);
    });
  </script>
</body>

</html>
